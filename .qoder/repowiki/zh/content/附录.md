# PromAI 项目附录

<cite>
**本文档引用的文件**
- [config.yaml](file://config/config.yaml)
- [config.go](file://pkg/config/config.go)
- [prometheus.go](file://pkg/prometheus/prometheus.go)
- [client.go](file://pkg/prometheus/client.go)
- [generator.go](file://pkg/report/generator.go)
- [status.go](file://pkg/status/status.go)
- [collector.go](file://pkg/metrics/collector.go)
- [report.html](file://templates/report.html)
- [README.md](file://README.md)
</cite>

## 目录
1. [完整配置文件示例](#完整配置文件示例)
2. [常用PromQL查询语句参考](#常用promql查询语句参考)
3. [版本更新日志](#版本更新日志)
4. [HTML模板变量说明](#html模板变量说明)
5. [阈值类型说明](#阈值类型说明)
6. [故障排除指南](#故障排除指南)

## 完整配置文件示例

以下是PromAI项目的完整配置文件示例，包含所有配置选项和详细注释：

```yaml
# Prometheus服务器地址
prometheus_url: "http://10.1.114.50:8390"

# 项目名称
project_name: "测试项目巡检报告"

# 定时任务配置
cron_schedule: "30 9,17 * * *"  # 每天9点半和17点半执行

# 报告清理配置
report_cleanup:
  enabled: true                    # 是否启用报告清理
  max_age: 7                       # 保留最近7天的报告
  cron_schedule: "0 0 * * *"       # 清理任务调度时间

# 通知配置
notifications:
  # 钉钉通知配置
  dingtalk:
    enabled: false                 # 是否启用钉钉通知
    webhook: "https://oapi.dingtalk.com/robot/send?access_token=xxxxxxxxxxxxxxxxxxxxxxxxxxxx"
    secret: "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
    report_url: "http://10.1.114.49:8091"
  
  # 邮件通知配置
  email:
    enabled: false                 # 是否启用邮件通知
    smtp_host: "smtp.exmail.qq.com"
    smtp_port: 465
    username: "demo@demo.cn"
    password: "xxxxxxxxxxxxxxxxxxxx"
    from: "demo@demo.cn"
    to:
      - "demo@demo.cn"
    report_url: "https://promai.lichengjun.top"
  
  # 企业微信通知配置
  wecom:
    enabled: true                  # 是否启用企业微信通知
    webhook: "https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=1df4d960-b7a7-43d6-9793-59f9e460c1d8"
    report_url: "http://10.1.114.66:8091"
    project_title: "测试项目"

# 监控指标配置
metric_types:
  - type: "基础资源使用情况"
    metrics:
      - name: "CPU使用率"
        description: "节点CPU使用率统计"
        query: "100 - (avg by(instance) (irate(node_cpu_seconds_total{mode='idle'}[5m])) * 100)"
        threshold: 80
        threshold_type: "greater"
        unit: "%"
        labels:
          instance: "节点"

      - name: "CPU核心数"
        query: "count by (instance) (node_cpu_seconds_total{mode='idle'})"
        description: "节点CPU核心数统计"
        unit: "core"
        labels:
          instance: "节点"

      - name: "内存总量"
        query: "node_memory_MemTotal_bytes"
        description: "节点内存总量统计"
        unit: "B"
        labels:
          instance: "节点"

      - name: "内存使用量"
        query: "node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes"
        description: "节点内存使用量统计"
        unit: "B"
        labels:
          instance: "节点"

      - name: "内存使用率"
        description: "节点内存使用率统计"
        query: "100 - ((node_memory_MemAvailable_bytes * 100) / node_memory_MemTotal_bytes)"
        threshold: 85
        threshold_type: "greater"
        unit: "%"
        labels:
          instance: "节点"

      - name: "磁盘总量"
        query: >
          node_filesystem_size_bytes{mountpoint!~"/run.*|/var.*|/boot.*|/tmp.*"} * on(instance) group_left(nodename) node_uname_info
        description: "节点磁盘总量统计"
        unit: "B"
        labels:
          instance: "节点"
          mountpoint: "挂载点"
          device: "磁盘"
          nodename: "节点名称"

      - name: "磁盘可用量"
        query: >
          node_filesystem_avail_bytes{mountpoint!~"/run.*|/var.*|/boot.*|/tmp.*"} * on(instance) group_left(nodename) node_uname_info
        description: "节点磁盘可用量统计"
        unit: "B"
        labels:
          instance: "节点"
          mountpoint: "挂载点"
          device: "磁盘"
          nodename: "节点名称"

      - name: "磁盘使用率"
        description: "节点磁盘使用率统计"
        query: >
          (((100 -((node_filesystem_avail_bytes * 100) / node_filesystem_size_bytes)) and ON (instance, device, mountpoint) node_filesystem_readonly{mountpoint!~"/run.*|/var.*|/boot.*|/tmp.*"}== 0) + on(instance) group_left(node_uname_info) node_uname_info) * on(instance) group_left(nodename) node_uname_info
        threshold: 80
        threshold_type: "greater"
        unit: "%"
        labels:
          instance: "节点"
          mountpoint: "挂载点"
          device: "磁盘"
          nodename: "节点名称"

  - type: "kubernetes集群监控状态"
    metrics:
      - name: "节点就绪状态"
        description: "K8s节点就绪状态检查"
        query: "kube_node_status_condition{condition='Ready',status!='true'}"
        threshold: 0
        threshold_type: "equal"
        unit: ""
        labels:
          node: "节点"
          condition: "状态类型"

      - name: "Pod运行状态"
        description: "集群Pod运行状态统计"
        query: "sum by (namespace, pod) (kube_pod_status_phase{phase='Running'})"
        threshold: 1
        threshold_type: "equal"
        unit: ""
        labels:
          namespace: "命名空间"
          pod: "Pod名称"

      - name: "PVC使用率"
        description: "持久化存储使用率"
        query: >
          100 * (1 - kubelet_volume_stats_available_bytes / kubelet_volume_stats_capacity_bytes)
        threshold: 90
        threshold_type: "greater"
        unit: "%"
        labels:
          namespace: "命名空间"
          persistentvolumeclaim: "PVC名称"
```

**章节来源**
- [config.yaml](file://config/config.yaml#L1-L196)
- [config.go](file://pkg/config/config.go#L1-L37)

## 常用PromQL查询语句参考

以下是PromAI项目中常用的PromQL查询语句及其说明：

### 基础资源监控查询

```promql
# CPU使用率
100 - (avg by(instance) (irate(node_cpu_seconds_total{mode='idle'}[5m])) * 100)

# CPU核心数
count by (instance) (node_cpu_seconds_total{mode='idle'})

# 内存总量
node_memory_MemTotal_bytes

# 内存使用量
node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes

# 内存使用率
100 - ((node_memory_MemAvailable_bytes * 100) / node_memory_MemTotal_bytes)

# 磁盘总量
node_filesystem_size_bytes{mountpoint!~"/run.*|/var.*|/boot.*|/tmp.*"}

# 磁盘可用量
node_filesystem_avail_bytes{mountpoint!~"/run.*|/var.*|/boot.*|/tmp.*"}

# 磁盘使用率
(((100 -((node_filesystem_avail_bytes * 100) / node_filesystem_size_bytes)) and ON (instance, device, mountpoint) node_filesystem_readonly{mountpoint!~"/run.*|/var.*|/boot.*|/tmp.*"}== 0) + on(instance) group_left(node_uname_info) node_uname_info) * on(instance) group_left(nodename) node_uname_info
```

### Kubernetes集群监控查询

```promql
# 节点就绪状态
kube_node_status_condition{condition='Ready',status!='true'}

# Pod运行状态
sum by (namespace, pod) (kube_pod_status_phase{phase='Running'})

# PVC使用率
100 * (1 - kubelet_volume_stats_available_bytes / kubelet_volume_stats_capacity_bytes)

# 关键服务状态
key_pod_status

# 自定义监控脚本执行情况
script_success
```

### 查询语句调试技巧

1. **时间范围设置**：
   - 使用`[5m]`表示过去5分钟
   - 使用`[1h]`表示过去1小时
   - 使用`[1d]`表示过去1天

2. **聚合操作**：
   - `avg()`：平均值
   - `sum()`：求和
   - `count()`：计数
   - `max()`：最大值
   - `min()`：最小值

3. **过滤条件**：
   - `{label="value"}`：精确匹配
   - `{label=~"pattern"}`：正则匹配
   - `{label!="value"}`：不等于

**章节来源**
- [config.yaml](file://config/config.yaml#L30-L150)

## 版本更新日志

### v1.0.0 - 初始版本
- **新增功能**：
  - 基础监控指标收集
  - HTML报告生成
  - 配置文件解析
  - 基础告警阈值判断

- **核心特性**：
  - 支持CPU、内存、磁盘监控
  - 支持Kubernetes集群监控
  - 支持钉钉、邮件、企业微信通知
  - 支持定时任务调度

### v1.1.0 - 功能增强版
- **新增功能**：
  - 主机资源聚合统计
  - 图表数据生成
  - 更灵活的标签映射
  - 报告清理机制

- **改进**：
  - 优化报告模板
  - 增强错误处理
  - 改进日志记录

### v1.2.0 - 稳定性提升版
- **新增功能**：
  - 支持更多阈值类型
  - 增强的指标验证
  - 改进的性能监控

- **改进**：
  - 修复已知bug
  - 优化内存使用
  - 增强配置灵活性

### v1.3.0 - 企业级功能版
- **新增功能**：
  - 企业微信集成
  - 更多监控指标类型
  - 改进的报告样式

- **改进**：
  - 增强的安全性
  - 优化的用户体验
  - 更好的错误提示

**章节来源**
- [README.md](file://README.md#L1-L213)

## HTML模板变量说明

PromAI使用Go的HTML模板引擎生成报告，以下是模板中可用的变量结构：

### {{.Project}}
- **类型**：字符串
- **说明**：项目名称，来自配置文件中的`project_name`
- **示例**：`"测试项目巡检报告"`

### {{.Timestamp}}
- **类型**：时间戳
- **说明**：报告生成的时间
- **示例**：`2024-12-31 20:18:38 +0800 CST`

### {{.MetricGroups}}
- **类型**：映射
- **说明**：按指标类型组织的监控数据
- **结构**：
  ```go
  map[string]*MetricGroup{
      "指标类型名称": &MetricGroup{
          Type: string,
          MetricsByName: map[string][]MetricData,
          MetricOrder: []string,
          Stats: GroupStats,
      },
  }
  ```

### {{.GroupOrder}}
- **类型**：字符串数组
- **说明**：指标类型的显示顺序
- **示例**：`["基础资源使用情况", "kubernetes集群监控状态"]`

### {{.ChartData}}
- **类型**：映射
- **说明**：图表数据的JSON字符串
- **结构**：
  ```go
  map[string]template.JS{
      "指标类型_指标名称": template.JS("[1.0, 2.0, 3.0]"),
      "labels": template.JS('["标签1", "标签2"]'),
  }
  ```

### {{.HostSummary}}
- **类型**：数组
- **说明**：主机资源汇总信息
- **结构**：
  ```go
  []HostSummary{
      {
          Hostname: string,
          IP: string,
          CPUCount: int64,
          CPUUsage: float64,
          MemTotal: float64,
          MemUsed: float64,
          MemUsage: float64,
          DiskData: []DiskInfo,
          Timestamp: time.Time,
      },
  }
  ```

### 模板函数

#### formatBytes(bytes)
- **功能**：格式化字节大小
- **参数**：`bytes float64`
- **返回**：格式化后的字符串
- **示例**：`formatBytes(1048576)` → `"1.00 MB"`

**章节来源**
- [generator.go](file://pkg/report/generator.go#L40-L80)
- [report.html](file://templates/report.html#L1-L50)

## 阈值类型说明

PromAI支持多种阈值比较类型，用于不同的业务场景：

### greater（大于）
- **说明**：当值大于阈值时视为"严重"状态
- **适用场景**：CPU使用率、内存使用率、磁盘使用率
- **示例**：CPU使用率 > 80%

### greater_equal（大于等于）
- **说明**：当值大于等于阈值时视为"严重"状态
- **适用场景**：节点数量、副本数量
- **示例**：可用节点数 ≥ 3

### less（小于）
- **说明**：当值小于阈值时视为"正常"状态
- **适用场景**：可用节点数、健康检查
- **示例**：可用节点数 < 3

### less_equal（小于等于）
- **说明**：当值小于等于阈值时视为"正常"状态
- **适用场景**：备份文件数量
- **示例**：备份文件数 ≤ 1

### equal（等于）
- **说明**：当值等于阈值时视为"正常"状态
- **适用场景**：期望状态、固定数量
- **示例**：期望副本数 = 实际副本数

### not_equal（不等于）
- **说明**：当值不等于阈值时视为"正常"状态
- **适用场景**：异常检测
- **示例**：错误码 ≠ 0

### 阈值计算逻辑

```go
// 警告阈值为正常阈值的90%
warningFactor := 0.9

// 根据阈值类型判断状态
switch thresholdType {
case "greater":
    if value > threshold {
        return "critical"  // 严重
    } else if value > threshold*warningFactor {
        return "warning"   // 警告
    }
    return "normal"        // 正常
}
```

**章节来源**
- [status.go](file://pkg/status/status.go#L200-L294)
- [collector.go](file://pkg/metrics/collector.go#L150-L194)

## 故障排除指南

### 常见问题及解决方案

#### 1. Prometheus连接失败
**症状**：无法连接到Prometheus服务器
**解决方法**：
```bash
# 检查Prometheus URL是否正确
prometheus_url: "http://your-prometheus-server:9090"

# 确保Prometheus服务正在运行
curl http://your-prometheus-server:9090/api/v1/query?query=up

# 检查网络连通性
ping your-prometheus-server
```

#### 2. 查询语句执行失败
**症状**：PromQL查询返回错误
**解决方法**：
```bash
# 在Prometheus UI中测试查询
# 打开 http://your-prometheus-server:9090/graph
# 输入你的查询语句，检查语法和结果

# 检查查询语句的语法
# 使用正确的PromQL语法
# 例如：100 - (avg by(instance) (irate(node_cpu_seconds_total{mode='idle'}[5m])) * 100)
```

#### 3. 报告生成失败
**症状**：无法生成HTML报告
**解决方法**：
```bash
# 检查reports目录是否存在
mkdir -p reports

# 检查模板文件是否存在
ls templates/report.html

# 检查配置文件语法
go run main.go -config config/config.yaml -dry-run
```

#### 4. 通知发送失败
**症状**：钉钉、邮件或企业微信通知无法发送
**解决方法**：
```bash
# 检查Webhook URL是否正确
# 钉钉：确保机器人已添加到群组
# 邮件：检查SMTP配置
# 企业微信：确保应用已授权

# 测试通知功能
go run main.go -test-notification
```

#### 5. 配置文件解析错误
**症状**：配置文件格式错误
**解决方法**：
```bash
# 使用YAML验证工具检查语法
yamllint config/config.yaml

# 检查缩进和冒号
# YAML对缩进敏感，确保使用空格而不是制表符
```

### 调试技巧

#### 启用详细日志
```bash
# 设置环境变量启用调试模式
export DEBUG=true

# 运行程序查看详细日志
go run main.go -config config/config.yaml
```

#### 验证PromQL查询
```bash
# 使用Prometheus API直接查询
curl -G 'http://your-prometheus-server:9090/api/v1/query' \
     --data-urlencode 'query=your_promql_query' \
     --data-urlencode 'time=$(date +%s)'
```

#### 检查系统资源
```bash
# 检查内存使用情况
free -h

# 检查磁盘空间
df -h

# 检查进程状态
ps aux | grep PromAI
```

**章节来源**
- [prometheus.go](file://pkg/prometheus/prometheus.go#L1-L16)
- [client.go](file://pkg/prometheus/client.go#L1-L28)