# 日志管理策略文档

<cite>
**本文档引用的文件**
- [main.go](file://main.go)
- [pkg/report/cleanup.go](file://pkg/report/cleanup.go)
- [config/config.yaml](file://config/config.yaml)
- [pkg/config/config.go](file://pkg/config/config.go)
- [pkg/notify/notify.go](file://pkg/notify/notify.go)
- [Dockerfile](file://Dockerfile)
- [deploy/deployment.yaml](file://deploy/deployment.yaml)
- [README.md](file://README.md)
</cite>

## 目录
1. [概述](#概述)
2. [日志输出规范](#日志输出规范)
3. [日志级别管理](#日志级别管理)
4. [容器化环境日志收集](#容器化环境日志收集)
5. [日志轮转配置](#日志轮转配置)
6. [结构化日志分析](#结构化日志分析)
7. [敏感信息保护](#敏感信息保护)
8. [典型日志条目解读](#典型日志条目解读)
9. [故障排除指南](#故障排除指南)
10. [最佳实践建议](#最佳实践建议)

## 概述

PromAI是一个基于Prometheus的监控报告自动生成工具，其日志管理系统贯穿整个应用生命周期，从应用启动到报告生成、清理等各个环节都提供了完整的日志记录机制。本文档详细阐述了PromAI的日志管理策略，包括日志输出规范、运维监控建议以及在不同环境下的部署注意事项。

## 日志输出规范

### 应用启动阶段日志

PromAI在启动时会输出详细的初始化信息，包括配置加载、服务启动等关键步骤：

```go
// 配置加载日志
log.Printf("使用环境变量中的 Prometheus URL: %s", envPrometheusURL)
log.Printf("使用配置文件中的 Prometheus URL: %s", config.PrometheusURL)

// 服务启动日志
log.Printf("Starting server on port: %s with config: %s", *port, *configPath)
log.Printf("Prometheus URL: %s", config.PrometheusURL)
```

### 定时任务执行日志

系统支持多种定时任务，每种任务都会产生相应的日志记录：

```go
// 指标收集日志
log.Printf("定时任务收集指标失败: %v", err)
log.Printf("定时任务生成报告失败: %v", err)
log.Printf("定时任务成功生成报告: %s", reportFilePath)

// 通知发送日志
log.Printf("发送钉钉消息")
log.Printf("发送邮件")
log.Printf("发送企业微信消息")

// 通知发送失败日志
log.Printf("发送钉钉消息失败: %v", err)
log.Printf("发送企业微信消息失败: %v", err)
```

### 报告清理日志

报告清理功能通过`CleanupReports`函数实现，该函数会在控制台输出删除操作记录：

```go
// 报告清理日志
log.Printf("报告清理失败: %v", err)
log.Printf("报告清理成功")
log.Printf("已删除过期报告: %s", path)
```

**章节来源**
- [main.go](file://main.go#L35-L45)
- [main.go](file://main.go#L75-L110)
- [main.go](file://main.go#L140-L170)
- [pkg/report/cleanup.go](file://pkg/report/cleanup.go#L25-L35)

## 日志级别管理

### 当前日志级别

PromAI目前使用Go标准库的`log`包，默认输出所有级别的日志信息到标准输出。这种设计使得日志能够无缝集成到容器化环境中的日志收集系统。

### 建议的日志级别开关

为了提高调试灵活性，建议在生产环境中实现可配置的日志级别开关：

```go
// 示例：日志级别配置结构
type LogLevel string

const (
    LevelDebug   LogLevel = "DEBUG"
    LevelInfo    LogLevel = "INFO"
    LevelWarning LogLevel = "WARNING"
    LevelError   LogLevel = "ERROR"
)

// 日志级别过滤函数
func shouldLog(level LogLevel, message string) bool {
    // 实现日志级别过滤逻辑
    return true // 当前返回全部日志
}
```

### 日志级别使用建议

- **DEBUG**: 仅在开发和调试阶段启用，包含详细的函数调用跟踪
- **INFO**: 生产环境的标准日志级别，记录重要业务流程
- **WARNING**: 记录潜在问题但不影响系统运行的情况
- **ERROR**: 记录错误事件，需要人工干预处理

## 容器化环境日志收集

### Docker日志驱动配置

PromAI容器默认将日志输出到标准输出，这使得它可以与各种容器日志驱动兼容：

```dockerfile
# Dockerfile中的日志配置
CMD ["./PromAI", "-port", "8091"]
```

### K8s环境日志收集

在Kubernetes环境中，PromAI的日志可以通过以下方式收集：

```yaml
# Pod配置示例
spec:
  containers:
  - name: promai
    image: 'kubehan/promai:latest'
    # 日志挂载点
    volumeMounts:
    - name: logs-volume
      mountPath: /var/log/promai
```

### 推荐的日志驱动配置

#### json-file驱动
```bash
# Docker守护进程配置
{
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "100m",
    "max-file": "3"
  }
}
```

#### syslog驱动
```bash
# Docker守护进程配置
{
  "log-driver": "syslog",
  "log-opts": {
    "syslog-address": "tcp://127.0.0.1:514",
    "tag": "{{.Name}}/{{.ID}}"
  }
}
```

**章节来源**
- [Dockerfile](file://Dockerfile#L32-L33)
- [deploy/deployment.yaml](file://deploy/deployment.yaml#L130-L140)

## 日志轮转配置

### 磁盘空间保护

为了避免日志文件无限增长导致磁盘空间耗尽，建议配置日志轮转策略：

```bash
# logrotate配置示例
/var/log/promai/*.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
    create 0644 root root
    postrotate
        systemctl reload promai
    endscript
}
```

### 容器内日志轮转

在容器环境中，可以使用专门的日志轮转工具：

```dockerfile
# 添加日志轮转工具
RUN apk add --no-cache logrotate

# 添加logrotate配置
COPY logrotate.conf /etc/logrotate.d/promai
```

### Kubernetes日志轮转

```yaml
# ConfigMap for logrotate
apiVersion: v1
kind: ConfigMap
metadata:
  name: logrotate-config
data:
  promai.conf: |
    /var/log/promai/*.log {
      daily
      rotate 7
      compress
      delaycompress
      missingok
      notifempty
      create 0644 root root
    }
```

## 结构化日志分析

### ELK Stack集成

建议将PromAI日志集成到ELK（Elasticsearch, Logstash, Kibana）栈中进行结构化分析：

```yaml
# Logstash配置示例
input {
  beats {
    port => 5044
  }
}

filter {
  grok {
    match => { "message" => "%{TIMESTAMP_ISO8601:timestamp} %{LOGLEVEL:level} %{GREEDYDATA:message}" }
  }
  
  date {
    match => [ "timestamp", "yyyy-MM-dd HH:mm:ss" ]
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "promai-%{+YYYY.MM.dd}"
  }
}
```

### Loki集成

对于轻量级部署，可以使用Grafana Loki进行日志聚合：

```yaml
# Loki配置示例
scrape_configs:
  - job_name: promai
    static_configs:
      - targets: ['localhost:8091']
        labels:
          service: promai
          __path__: /var/log/promai/*.log
```

### 日志分析指标

建议监控以下关键指标：
- 错误日志频率
- 关键业务操作日志
- 系统资源使用情况
- 外部服务调用成功率

## 敏感信息保护

### 当前敏感信息处理

PromAI在日志中已经注意避免直接输出敏感信息：

```go
// 安全的日志记录
log.Printf("使用环境变量中的 Prometheus URL: %s", envPrometheusURL)
log.Printf("使用配置文件中的 Prometheus URL: %s", config.PrometheusURL)
```

### 建议的敏感信息处理策略

#### 配置文件中的敏感信息
```yaml
# 敏感信息配置示例
notifications:
  email:
    password: "${EMAIL_PASSWORD}"  # 使用环境变量
    username: "${EMAIL_USERNAME}"
```

#### 日志中的敏感信息过滤
```go
// 敏感信息过滤函数
func sanitizeLogMessage(message string) string {
    // 过滤密码
    message = redactor.ReplaceAllString(message, "***")
    // 过滤token
    message = tokenRedactor.ReplaceAllString(message, "TOKEN_REDACTED")
    return message
}
```

### 敏感信息白名单

建议建立敏感信息白名单，只允许特定信息出现在日志中：

```go
// 白名单配置
var safeFields = map[string]bool{
    "project_name": true,
    "cron_schedule": true,
    "max_age": true,
    "report_url": true,
}
```

**章节来源**
- [main.go](file://main.go#L35-L40)
- [config/config.yaml](file://config/config.yaml#L1-L10)

## 典型日志条目解读

### 应用启动日志

```
2024-01-15 10:30:00 INFO Starting server on port: 8091 with config: config/config.yaml
2024-01-15 10:30:00 INFO Prometheus URL: http://prometheus.example.com:9090
2024-01-15 10:30:00 INFO 获取报告地址: http://localhost:8091/getreport
2024-01-15 10:30:00 INFO 健康看板地址: http://localhost:8091/status
```

**解读说明**：
- 时间戳精确到秒，便于时间序列分析
- INFO级别表明这是正常的启动信息
- 包含了服务地址和功能入口

### 定时任务执行日志

```
2024-01-15 10:30:05 INFO 定时任务收集指标失败: connection refused
2024-01-15 10:30:10 INFO 定时任务生成报告失败: failed to connect to database
2024-01-15 10:30:15 INFO 定时任务成功生成报告: reports/inspection_report_20240115_103015.html
```

**解读说明**：
- 失败日志包含具体错误信息，便于排查
- 成功日志包含生成的报告路径
- 时间间隔有助于评估任务执行效率

### 通知发送日志

```
2024-01-15 10:30:20 INFO 发送钉钉消息
2024-01-15 10:30:25 INFO 发送邮件
2024-01-15 10:30:30 INFO 发送企业微信消息
2024-01-15 10:30:35 INFO 发送钉钉消息失败: webhook timeout
```

**解读说明**：
- 每个通知渠道都有独立的日志记录
- 失败日志包含具体的错误原因
- 便于追踪通知系统的健康状况

### 报告清理日志

```
2024-01-15 00:00:00 INFO 报告清理失败: permission denied
2024-01-15 00:00:05 INFO 报告清理成功
2024-01-15 00:00:10 INFO 已删除过期报告: reports/inspection_report_20240110_123456.html
```

**解读说明**：
- 清理操作有明确的成功/失败状态
- 删除的具体文件路径被记录
- 便于验证清理策略的有效性

## 故障排除指南

### 常见日志问题诊断

#### 1. 配置加载失败
```
Error setting up: loading config: reading config file: open config/config.yaml: no such file or directory
```
**解决方案**：
- 检查配置文件路径是否正确
- 确认文件权限设置
- 验证YAML语法格式

#### 2. Prometheus连接失败
```
定时任务收集指标失败: connection refused
```
**解决方案**：
- 检查Prometheus服务器状态
- 验证网络连通性
- 确认URL配置正确

#### 3. 报告生成失败
```
定时任务生成报告失败: failed to connect to database
```
**解决方案**：
- 检查数据库连接配置
- 验证数据库服务状态
- 确认认证凭据正确

#### 4. 通知发送失败
```
发送钉钉消息失败: webhook timeout
```
**解决方案**：
- 检查网络连接
- 验证Webhook URL有效性
- 确认防火墙设置

### 日志分析工具

#### 使用jq进行日志解析
```bash
# 提取错误日志
cat app.log | jq 'select(.level=="ERROR")'

# 统计各类日志数量
cat app.log | jq -r '.level' | sort | uniq -c

# 按小时统计日志
cat app.log | jq -r '.timestamp[:13]' | sort | uniq -c
```

#### 使用grep进行快速搜索
```bash
# 查找所有错误日志
grep "ERROR" app.log

# 查找特定时间段的日志
grep "2024-01-15 10:30" app.log

# 查找包含特定关键词的日志
grep -i "failed" app.log
```

## 最佳实践建议

### 日志配置最佳实践

1. **统一日志格式**
```go
// 使用结构化日志格式
type LogEntry struct {
    Timestamp time.Time `json:"timestamp"`
    Level     string    `json:"level"`
    Message   string    `json:"message"`
    Service   string    `json:"service"`
    Version   string    `json:"version"`
}
```

2. **异步日志写入**
```go
// 使用缓冲区提高性能
logger := log.New(bufferedWriter, "", log.LstdFlags)
```

3. **日志采样**
```go
// 对高频日志进行采样
if rand.Float32() < 0.1 {
    log.Printf("Sampling log entry")
}
```

### 监控告警配置

建议配置以下关键监控指标：

```yaml
# Prometheus告警规则示例
groups:
- name: promai-alerts
  rules:
  - alert: PromAILogErrorRate
    expr: rate(log_errors_total[5m]) > 0.1
    for: 2m
    labels:
      severity: warning
    annotations:
      summary: "PromAI错误日志率过高"
      
  - alert: PromAIReportGenerationFailure
    expr: increase(promai_report_generation_failures_total[1h]) > 0
    for: 0m
    labels:
      severity: critical
    annotations:
      summary: "PromAI报告生成失败"
```

### 性能监控

建议监控以下性能指标：
- 日志写入延迟
- 日志文件大小增长速率
- 日志处理吞吐量
- 内存使用情况

### 文档维护

定期更新日志管理文档，包括：
- 新增的功能模块日志记录
- 日志格式变更说明
- 故障排除案例积累
- 最佳实践更新

通过实施这些日志管理策略，PromAI系统将具备完善的可观测性能力，能够在生产环境中稳定运行并快速定位问题。建议根据实际业务需求调整日志级别和收集策略，确保既能满足运维监控需求，又不会造成过多的资源消耗。